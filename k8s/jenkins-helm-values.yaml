# Jenkins Helm Chart Values
# This file configures Jenkins deployment via Helm chart
# 
# IMPORTANT: Before deploying, update the following placeholders:
# - JENKINS_URL: Replace with your actual Jenkins ALB DNS name after deployment
# - AWS_ACCOUNT_ID: Replace with your AWS account ID
#
# To get Jenkins URL after deployment:
# kubectl get ingress jenkins -n jenkins -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'

controller:
  # Use existing service account with IRSA
  serviceAccount:
    create: false
    name: jenkins-controller
  
  # Controller resources
  resources:
    requests:
      cpu: "2000m"
      memory: "8Gi"
    limits:
      cpu: "4"
      memory: "12Gi"
  
  # Java options
  javaOpts: "-Xmx8g -Xms4g"
  
  # Jenkins options
  jenkinsOpts: "--sessionTimeout=1440"
  
  # Number of executors (0 = force all builds to agents)
  numExecutors: 0
  
  # Node selector for controller
  nodeSelector:
    workload-type: jenkins-controller
  
  # Tolerations for controller node
  tolerations:
  - key: workload-type
    operator: Equal
    value: jenkins-controller
    effect: NoSchedule
  
  # Service configuration
  serviceType: ClusterIP
  servicePort: 8080
  
  # Jenkins URL configuration
  # IMPORTANT: Replace JENKINS_URL with actual ALB DNS name after deployment
  # Get it with: kubectl get ingress jenkins -n jenkins -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  jenkinsUrl: "http://JENKINS_URL/"
  jenkinsUriPrefix: ""
  
  # Ingress configuration
  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/healthcheck-path: /login
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
      alb.ingress.kubernetes.io/tags: Environment=production,Application=jenkins
      # Subnets are auto-discovered based on tags:
      # - kubernetes.io/role/elb=1 (for public subnets)
      # - kubernetes.io/cluster/jenkins-eks-cluster=shared
      # Security: Restrict access to specific IP ranges
      # Update this list with your organization's IP ranges
      alb.ingress.kubernetes.io/inbound-cidrs: 0.0.0.0/0
    # IMPORTANT: Replace JENKINS_URL with actual ALB DNS name after deployment
    hostName: JENKINS_URL
  
  # Install required plugins
  installPlugins:
    - kubernetes:4360.v0e4b_1c40e9e5
    - workflow-aggregator:600.vb_57cdd26fdd7
    - git:5.7.0
    - configuration-as-code:1909.vb_b_f59a_b_b_5d61
    - job-dsl:1.92
    - docker-workflow:580.vc0c340686b_54
  
  # Jenkins Configuration as Code
  JCasC:
    defaultConfig: true
    configScripts:
      welcome-message: |
        jenkins:
          systemMessage: "Jenkins on EKS - Configured via Helm + JCasC"
      jenkins-url: |
        unclassified:
          location:
            # IMPORTANT: Replace JENKINS_URL with actual ALB DNS name after deployment
            url: "http://JENKINS_URL/"
      kubernetes-cloud: |
        jenkins:
          clouds:
          - kubernetes:
              name: "kubernetes"
              serverUrl: "https://kubernetes.default"
              namespace: "jenkins"
              jenkinsUrl: "http://jenkins:8080"
              jenkinsTunnel: "jenkins:50000"
              connectTimeout: 5
              readTimeout: 15
              containerCapStr: "10"
              maxRequestsPerHostStr: "32"
              retentionTimeout: 5
              templates:
              - name: "jenkins-agent-dind"
                namespace: "jenkins"
                label: "jenkins-agent"
                nodeUsageMode: NORMAL
                idleMinutes: 10
                serviceAccount: "jenkins-controller"
                yaml: |
                  apiVersion: v1
                  kind: Pod
                  spec:
                    affinity:
                      nodeAffinity:
                        preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          preference:
                            matchExpressions:
                            - key: node-lifecycle
                              operator: In
                              values:
                              - spot
                      podAntiAffinity:
                        requiredDuringSchedulingIgnoredDuringExecution:
                        - labelSelector:
                            matchExpressions:
                            - key: app
                              operator: In
                              values:
                              - jenkins-controller
                          topologyKey: kubernetes.io/hostname
                    containers:
                    - name: jnlp
                      image: jenkins/inbound-agent:latest
                      env:
                      - name: DOCKER_HOST
                        value: tcp://localhost:2375
                      resources:
                        requests:
                          cpu: 500m
                          memory: 1Gi
                        limits:
                          cpu: 1
                          memory: 2Gi
                      volumeMounts:
                      - name: workspace-volume
                        mountPath: /home/jenkins/agent
                    - name: docker
                      image: docker:24-dind
                      securityContext:
                        privileged: true
                      env:
                      - name: DOCKER_TLS_CERTDIR
                        value: ""
                      resources:
                        requests:
                          cpu: 500m
                          memory: 1Gi
                        limits:
                          cpu: 2
                          memory: 4Gi
                      volumeMounts:
                      - name: docker-storage
                        mountPath: /var/lib/docker
                    volumes:
                    - name: workspace-volume
                      emptyDir: {}
                    - name: docker-storage
                      emptyDir: {}
      jobs: |
        jobs:
          - script: >
              pipelineJob('nginx-docker-build') {
                description('Build and push nginx Docker image to ECR')
                definition {
                  cps {
                    script('''
pipeline {
    agent {
        kubernetes {
            label 'docker-build'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
    job: docker-build
spec:
  serviceAccountName: jenkins-controller
  containers:
  - name: docker
    image: docker:24-dind
    securityContext:
      privileged: true
    command:
    - dockerd
    - --host=unix:///var/run/docker.sock
    - --host=tcp://0.0.0.0:2375
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run
  - name: aws-cli
    image: amazon/aws-cli:latest
    command:
    - cat
    tty: true
  volumes:
  - name: docker-sock
    emptyDir: {}
"""
        }
    }
    
    environment {
        AWS_REGION = 'us-west-2'
        // IMPORTANT: Replace AWS_ACCOUNT_ID with your AWS account ID
        // Get it with: aws sts get-caller-identity --query Account --output text
        AWS_ACCOUNT_ID = 'AWS_ACCOUNT_ID'
        ECR_REPOSITORY = 'nginx-demo'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        ECR_REGISTRY = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Creating build files...'
                script {
                    writeFile file: 'Dockerfile', text: \'\'\'FROM nginx:alpine
COPY nginx.conf /etc/nginx/nginx.conf
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
\'\'\'
                    writeFile file: 'nginx.conf', text: \'\'\'user nginx;
worker_processes auto;
events { worker_connections 1024; }
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    server {
        listen 80;
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
}
\'\'\'
                    writeFile file: 'index.html', text: \'\'\'<!DOCTYPE html>
<html><head><title>Nginx Demo</title></head>
<body><h1>Built with Jenkins on EKS</h1><p>Build #\'\'\' + env.BUILD_NUMBER + \'\'\'</p></body></html>
\'\'\'
                }
            }
        }
        
        stage('Build') {
            steps {
                container('docker') {
                    sh """
                        docker build -t ${ECR_REPOSITORY}:${IMAGE_TAG} .
                        docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REPOSITORY}:latest
                    """
                }
            }
        }
        
        stage('ECR Login') {
            steps {
                container('aws-cli') {
                    sh "aws ecr get-login-password --region ${AWS_REGION} > /tmp/ecr-password"
                }
                container('docker') {
                    sh "cat /tmp/ecr-password | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                }
            }
        }
        
        stage('Push') {
            steps {
                container('docker') {
                    sh """
                        docker tag ${ECR_REPOSITORY}:${IMAGE_TAG} ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                        docker tag ${ECR_REPOSITORY}:latest ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                        docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:latest
                    """
                }
            }
        }
    }
}
                    ''')
                    sandbox()
                  }
                }
              }

# Disable agent (we use dynamic Kubernetes agents)
agent:
  enabled: false

# Persistence for Jenkins home (at root level for Helm chart)
persistence:
  enabled: true
  storageClass: efs-sc
  size: 100Gi
  accessMode: ReadWriteMany

# RBAC - Helm chart will create these
rbac:
  create: true
  readSecrets: true
