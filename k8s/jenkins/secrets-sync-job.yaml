apiVersion: batch/v1
kind: Job
metadata:
  name: jenkins-secrets-sync
  namespace: jenkins
spec:
  template:
    spec:
      serviceAccountName: jenkins-controller
      restartPolicy: OnFailure
      # Toleration to allow scheduling on nodes with jenkins-controller taint
      tolerations:
      - key: workload-type
        operator: Equal
        value: jenkins-controller
        effect: NoSchedule
      containers:
      - name: sync-secrets
        image: amazon/aws-cli:latest
        command:
        - /bin/sh
        - -c
        - |
          # Get GitHub webhook secret from Secrets Manager
          GITHUB_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id jenkins/github-webhook-secret \
            --region ${AWS_REGION} \
            --query SecretString \
            --output text | jq -r .secret)
          
          # Generate admin password (or retrieve from Secrets Manager if you created one)
          ADMIN_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id jenkins/admin-password \
            --region ${AWS_REGION} \
            --query SecretString \
            --output text 2>/dev/null || echo "admin123")
          
          # Create Kubernetes secret
          kubectl create secret generic jenkins-secrets \
            --from-literal=admin-password="$ADMIN_PASSWORD" \
            --from-literal=github-webhook-secret="$GITHUB_SECRET" \
            --namespace=jenkins \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "âœ“ Secrets synced successfully"
        env:
        - name: AWS_REGION
          value: "us-west-2"
