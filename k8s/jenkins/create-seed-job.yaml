apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-seed-job-script
  namespace: jenkins
data:
  create-seed-job.sh: |
    #!/bin/sh
    set -e
    
    echo "Waiting for Jenkins..."
    until curl -s -f http://jenkins:8080/login > /dev/null; do
      sleep 5
    done
    
    cat > /tmp/job.xml << 'JOBXML'
    <?xml version='1.1' encoding='UTF-8'?>
    <project>
      <description>Seed job for Job DSL</description>
      <scm class="hudson.plugins.git.GitSCM">
        <userRemoteConfigs>
          <hudson.plugins.git.UserRemoteConfig>
            <url>https://github.com/peterboddev/eks_jenkins_central_api_gw_app_ekses.git</url>
          </hudson.plugins.git.UserRemoteConfig>
        </userRemoteConfigs>
        <branches>
          <hudson.plugins.git.BranchSpec>
            <name>*/main</name>
          </hudson.plugins.git.BranchSpec>
        </branches>
      </scm>
      <builders>
        <javaposse.jobdsl.plugin.ExecuteDslScripts>
          <targets>jenkins-jobs/seed-job.groovy</targets>
          <sandbox>false</sandbox>
        </javaposse.jobdsl.plugin.ExecuteDslScripts>
      </builders>
    </project>
    JOBXML
    
    CRUMB=$(curl -s -u admin:${JENKINS_ADMIN_PASSWORD} 'http://jenkins:8080/crumbIssuer/api/json')
    FIELD=$(echo $CRUMB | grep -o '"crumbRequestField":"[^"]*"' | cut -d'"' -f4)
    VALUE=$(echo $CRUMB | grep -o '"crumb":"[^"]*"' | cut -d'"' -f4)
    
    curl -X POST -u admin:${JENKINS_ADMIN_PASSWORD} \
      -H "Content-Type: application/xml" \
      --data-binary @/tmp/job.xml \
      "http://jenkins:8080/createItem?name=seed-job&${FIELD}=${VALUE}" || echo "Job may exist"
    
    sleep 5
    curl -X POST -u admin:${JENKINS_ADMIN_PASSWORD} \
      "http://jenkins:8080/job/seed-job/build?${FIELD}=${VALUE}"
    
    echo "Done"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: jenkins-create-seed-job
  namespace: jenkins
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      tolerations:
      - key: workload-type
        operator: Equal
        value: jenkins-controller
        effect: NoSchedule
      containers:
      - name: create-seed-job
        image: curlimages/curl:latest
        command: ["/bin/sh", "/scripts/create-seed-job.sh"]
        env:
        - name: JENKINS_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: jenkins-secrets
              key: admin-password
        volumeMounts:
        - name: script
          mountPath: /scripts
      volumes:
      - name: script
        configMap:
          name: jenkins-seed-job-script
          defaultMode: 0755
