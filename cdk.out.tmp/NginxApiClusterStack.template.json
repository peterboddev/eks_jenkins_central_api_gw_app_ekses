{
 "Description": "Nginx REST API cluster on Amazon EKS with Karpenter and API Gateway",
 "Resources": {
  "ClusterRoleD9CA7471": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "eks.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonEKSClusterPolicy"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/ClusterRole/Resource"
   }
  },
  "ClusterSecurityGroup94AE9AAE": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for EKS cluster control plane",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "SecurityGroupIngress": [
     {
      "CidrIp": "10.0.0.0/16",
      "Description": "Allow kubectl access from Jenkins VPC",
      "FromPort": 443,
      "IpProtocol": "tcp",
      "ToPort": 443
     }
    ],
    "VpcId": {
     "Fn::ImportValue": "NginxApiNetworkStack:ExportsOutputRefNginxApiVpcB7BEAB926351F217"
    }
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/ClusterSecurityGroup/Resource"
   }
  },
  "KubectlLayer600207B5": {
   "Type": "AWS::Lambda::LayerVersion",
   "Properties": {
    "CompatibleRuntimes": [
     "python3.13",
     "python3.12",
     "python3.11",
     "provided.al2023"
    ],
    "Content": {
     "S3Bucket": "cdk-hnb659fds-assets-450683699755-us-west-2",
     "S3Key": "954e6e9b0c5b52a5026f0d4d400be8b316ee39dd23b73850ca64dcb5ca305a10.zip"
    },
    "Description": "kubectl layer placeholder"
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/KubectlLayer/Resource",
    "aws:asset:path": "asset.954e6e9b0c5b52a5026f0d4d400be8b316ee39dd23b73850ca64dcb5ca305a10.zip",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Content"
   }
  },
  "ClusterKubectlHandlerRole94549F93": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonEC2ContainerRegistryPullOnly"
       ]
      ]
     },
     {
      "Fn::If": [
       "ClusterHasEcrPublic8EE1114E",
       {
        "Fn::Join": [
         "",
         [
          "arn:",
          {
           "Ref": "AWS::Partition"
          },
          ":iam::aws:policy/AmazonElasticContainerRegistryPublicReadOnly"
         ]
        ]
       },
       {
        "Ref": "AWS::NoValue"
       }
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/Cluster/KubectlHandlerRole/Resource"
   }
  },
  "ClusterKubectlHandlerRoleDefaultPolicyE44083DD": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "eks:DescribeCluster",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "Cluster9EE0221C",
         "Arn"
        ]
       }
      },
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ClusterCreationRole360249B6",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ClusterKubectlHandlerRoleDefaultPolicyE44083DD",
    "Roles": [
     {
      "Ref": "ClusterKubectlHandlerRole94549F93"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/Cluster/KubectlHandlerRole/DefaultPolicy/Resource"
   }
  },
  "ClusterCreationRole360249B6": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "AWS": [
         {
          "Fn::GetAtt": [
           "ClusterKubectlHandlerRole94549F93",
           "Arn"
          ]
         },
         {
          "Fn::GetAtt": [
           "awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454",
           "Outputs.NginxApiClusterStackawscdkawseksClusterResourceProviderIsCompleteHandlerServiceRole898D2526Arn"
          ]
         },
         {
          "Fn::GetAtt": [
           "awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454",
           "Outputs.NginxApiClusterStackawscdkawseksClusterResourceProviderOnEventHandlerServiceRoleB4FB6221Arn"
          ]
         }
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/Cluster/Resource/CreationRole/Resource"
   }
  },
  "ClusterCreationRoleDefaultPolicyE8BDFC7B": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "iam:PassRole",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ClusterRoleD9CA7471",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "eks:CreateCluster",
        "eks:CreateFargateProfile",
        "eks:DeleteCluster",
        "eks:DescribeCluster",
        "eks:DescribeUpdate",
        "eks:TagResource",
        "eks:UntagResource",
        "eks:UpdateClusterConfig",
        "eks:UpdateClusterVersion"
       ],
       "Effect": "Allow",
       "Resource": [
        "arn:aws:eks:us-west-2:450683699755:cluster/nginx-api-cluster",
        "arn:aws:eks:us-west-2:450683699755:cluster/nginx-api-cluster/*"
       ]
      },
      {
       "Action": [
        "eks:DeleteFargateProfile",
        "eks:DescribeFargateProfile"
       ],
       "Effect": "Allow",
       "Resource": "arn:aws:eks:us-west-2:450683699755:fargateprofile/nginx-api-cluster/*"
      },
      {
       "Action": [
        "ec2:DescribeDhcpOptions",
        "ec2:DescribeInstances",
        "ec2:DescribeNetworkInterfaces",
        "ec2:DescribeRouteTables",
        "ec2:DescribeSecurityGroups",
        "ec2:DescribeSubnets",
        "ec2:DescribeVpcs",
        "iam:CreateServiceLinkedRole",
        "iam:GetRole",
        "iam:listAttachedRolePolicies"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ClusterCreationRoleDefaultPolicyE8BDFC7B",
    "Roles": [
     {
      "Ref": "ClusterCreationRole360249B6"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/Cluster/Resource/CreationRole/DefaultPolicy/Resource"
   }
  },
  "Cluster9EE0221C": {
   "Type": "Custom::AWSCDK-EKS-Cluster",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454",
      "Outputs.NginxApiClusterStackawscdkawseksClusterResourceProviderframeworkonEventD2EB1089Arn"
     ]
    },
    "Config": {
     "name": "nginx-api-cluster",
     "version": "1.32",
     "roleArn": {
      "Fn::GetAtt": [
       "ClusterRoleD9CA7471",
       "Arn"
      ]
     },
     "kubernetesNetworkConfig": {
      "ipFamily": "ipv4"
     },
     "resourcesVpcConfig": {
      "subnetIds": [
       {
        "Fn::ImportValue": "NginxApiNetworkStack:ExportsOutputRefNginxApiVpcPrivateSubnet1Subnet1174CD0B767F3D15"
       },
       {
        "Fn::ImportValue": "NginxApiNetworkStack:ExportsOutputRefNginxApiVpcPrivateSubnet2SubnetD6B4249DE818A381"
       }
      ],
      "securityGroupIds": [
       {
        "Fn::GetAtt": [
         "ClusterSecurityGroup94AE9AAE",
         "GroupId"
        ]
       }
      ],
      "endpointPublicAccess": true,
      "endpointPrivateAccess": true
     },
     "logging": {
      "clusterLogging": [
       {
        "enabled": true,
        "types": [
         "audit",
         "authenticator",
         "controllerManager"
        ]
       }
      ]
     },
     "accessConfig": {}
    },
    "AssumeRoleArn": {
     "Fn::GetAtt": [
      "ClusterCreationRole360249B6",
      "Arn"
     ]
    },
    "AttributesRevision": 5
   },
   "DependsOn": [
    "ClusterCreationRoleDefaultPolicyE8BDFC7B",
    "ClusterCreationRole360249B6"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/Cluster/Resource/Resource/Default"
   }
  },
  "ClusterKubectlReadyBarrier200052AF": {
   "Type": "AWS::SSM::Parameter",
   "Properties": {
    "Type": "String",
    "Value": "aws:cdk:eks:kubectl-ready"
   },
   "DependsOn": [
    "ClusterCreationRoleDefaultPolicyE8BDFC7B",
    "ClusterCreationRole360249B6",
    "Cluster9EE0221C"
   ],
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/Cluster/KubectlReadyBarrier"
   }
  },
  "awscdkawseksClusterResourceProviderNestedStackawscdkawseksClusterResourceProviderNestedStackResource9827C454": {
   "Type": "AWS::CloudFormation::Stack",
   "Properties": {
    "TemplateURL": {
     "Fn::Join": [
      "",
      [
       "https://s3.us-west-2.",
       {
        "Ref": "AWS::URLSuffix"
       },
       "/cdk-hnb659fds-assets-450683699755-us-west-2/24ce2bbe0caff455f4630f76259aad3a3e99b9ddbd0df1b33d6f625c8da8c757.json"
      ]
     ]
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/@aws-cdk--aws-eks.ClusterResourceProvider.NestedStack/@aws-cdk--aws-eks.ClusterResourceProvider.NestedStackResource",
    "aws:asset:path": "NginxApiClusterStackawscdkawseksClusterResourceProviderD7D2AC3B.nested.template.json",
    "aws:asset:property": "TemplateURL"
   }
  },
  "awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B": {
   "Type": "AWS::CloudFormation::Stack",
   "Properties": {
    "Parameters": {
     "referencetoNginxApiClusterStackKubectlLayerCAE4174ARef": {
      "Ref": "KubectlLayer600207B5"
     },
     "referencetoNginxApiClusterStackClusterKubectlHandlerRoleC00976B7Arn": {
      "Fn::GetAtt": [
       "ClusterKubectlHandlerRole94549F93",
       "Arn"
      ]
     },
     "referencetoNginxApiClusterStackClusterE83207E7ClusterSecurityGroupId": {
      "Fn::GetAtt": [
       "Cluster9EE0221C",
       "ClusterSecurityGroupId"
      ]
     }
    },
    "TemplateURL": {
     "Fn::Join": [
      "",
      [
       "https://s3.us-west-2.",
       {
        "Ref": "AWS::URLSuffix"
       },
       "/cdk-hnb659fds-assets-450683699755-us-west-2/2509a6300bb3f920d3acc74cbbfc3bf2359e3c41d9533ff5229def3349c75269.json"
      ]
     ]
    }
   },
   "DependsOn": [
    "ClusterKubectlHandlerRoleDefaultPolicyE44083DD",
    "ClusterKubectlHandlerRole94549F93"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/@aws-cdk--aws-eks.KubectlProvider.NestedStack/@aws-cdk--aws-eks.KubectlProvider.NestedStackResource",
    "aws:asset:path": "NginxApiClusterStackawscdkawseksKubectlProviderAF613EB6.nested.template.json",
    "aws:asset:property": "TemplateURL"
   }
  },
  "KarpenterNodeRole4664A89A": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ec2.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonEKSWorkerNodePolicy"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonEKS_CNI_Policy"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonSSMManagedInstanceCore"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/KarpenterNodeRole/Resource"
   }
  },
  "KarpenterNodeRoleDefaultPolicyE55D6760": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ecr:BatchCheckLayerAvailability",
        "ecr:BatchGetImage",
        "ecr:GetAuthorizationToken",
        "ecr:GetDownloadUrlForLayer"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "KarpenterNodeRoleDefaultPolicyE55D6760",
    "Roles": [
     {
      "Ref": "KarpenterNodeRole4664A89A"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/KarpenterNodeRole/DefaultPolicy/Resource"
   }
  },
  "KarpenterInstanceProfile": {
   "Type": "AWS::IAM::InstanceProfile",
   "Properties": {
    "InstanceProfileName": {
     "Fn::Join": [
      "",
      [
       "KarpenterNodeInstanceProfile-",
       {
        "Ref": "Cluster9EE0221C"
       }
      ]
     ]
    },
    "Roles": [
     {
      "Ref": "KarpenterNodeRole4664A89A"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/KarpenterInstanceProfile"
   }
  },
  "KarpenterInterruptionQueue89CE5952": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "MessageRetentionPeriod": 300,
    "QueueName": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "Cluster9EE0221C"
       },
       "-karpenter-interruption"
      ]
     ]
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/KarpenterInterruptionQueue/Resource"
   }
  },
  "KarpenterInterruptionQueuePolicy7811CC26": {
   "Type": "AWS::SQS::QueuePolicy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:SendMessage"
       ],
       "Condition": {
        "ArnEquals": {
         "aws:SourceArn": {
          "Fn::GetAtt": [
           "EC2StateChangeRuleD816BE38",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "events.amazonaws.com"
       },
       "Resource": {
        "Fn::GetAtt": [
         "KarpenterInterruptionQueue89CE5952",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:SendMessage"
       ],
       "Condition": {
        "ArnEquals": {
         "aws:SourceArn": {
          "Fn::GetAtt": [
           "EC2SpotInterruptionRule5556EA27",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "events.amazonaws.com"
       },
       "Resource": {
        "Fn::GetAtt": [
         "KarpenterInterruptionQueue89CE5952",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:SendMessage"
       ],
       "Condition": {
        "ArnEquals": {
         "aws:SourceArn": {
          "Fn::GetAtt": [
           "EC2RebalanceRule00F96BCA",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "events.amazonaws.com"
       },
       "Resource": {
        "Fn::GetAtt": [
         "KarpenterInterruptionQueue89CE5952",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Queues": [
     {
      "Ref": "KarpenterInterruptionQueue89CE5952"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/KarpenterInterruptionQueue/Policy/Resource"
   }
  },
  "EC2StateChangeRuleD816BE38": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "EventPattern": {
     "source": [
      "aws.ec2"
     ],
     "detail-type": [
      "EC2 Instance State-change Notification"
     ]
    },
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "KarpenterInterruptionQueue89CE5952",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/EC2StateChangeRule/Resource"
   }
  },
  "EC2SpotInterruptionRule5556EA27": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "EventPattern": {
     "source": [
      "aws.ec2"
     ],
     "detail-type": [
      "EC2 Spot Instance Interruption Warning"
     ]
    },
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "KarpenterInterruptionQueue89CE5952",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/EC2SpotInterruptionRule/Resource"
   }
  },
  "EC2RebalanceRule00F96BCA": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "EventPattern": {
     "source": [
      "aws.ec2"
     ],
     "detail-type": [
      "EC2 Instance Rebalance Recommendation"
     ]
    },
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "KarpenterInterruptionQueue89CE5952",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/EC2RebalanceRule/Resource"
   }
  },
  "ALBSecurityGroup29A3BDEF": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for public ALB",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "SecurityGroupIngress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow HTTPS from API Gateway",
      "FromPort": 443,
      "IpProtocol": "tcp",
      "ToPort": 443
     }
    ],
    "VpcId": {
     "Fn::ImportValue": "NginxApiNetworkStack:ExportsOutputRefNginxApiVpcB7BEAB926351F217"
    }
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/ALBSecurityGroup/Resource"
   }
  },
  "ApiGatewayLogGroupA9770429": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": {
     "Fn::Join": [
      "",
      [
       "/aws/apigateway/",
       {
        "Ref": "Cluster9EE0221C"
       }
      ]
     ]
    },
    "RetentionInDays": 7
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/ApiGatewayLogGroup/Resource"
   }
  },
  "HttpApi": {
   "Type": "AWS::ApiGatewayV2::Api",
   "Properties": {
    "CorsConfiguration": {
     "AllowHeaders": [
      "Content-Type",
      "Authorization"
     ],
     "AllowMethods": [
      "GET",
      "POST",
      "PUT",
      "DELETE",
      "OPTIONS"
     ],
     "AllowOrigins": [
      "*"
     ]
    },
    "Name": {
     "Fn::Join": [
      "",
      [
       {
        "Ref": "Cluster9EE0221C"
       },
       "-api"
      ]
     ]
    },
    "ProtocolType": "HTTP"
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/HttpApi"
   }
  },
  "ApiStage": {
   "Type": "AWS::ApiGatewayV2::Stage",
   "Properties": {
    "AccessLogSettings": {
     "DestinationArn": {
      "Fn::GetAtt": [
       "ApiGatewayLogGroupA9770429",
       "Arn"
      ]
     },
     "Format": "{\"requestId\":\"$context.requestId\",\"ip\":\"$context.identity.sourceIp\",\"requestTime\":\"$context.requestTime\",\"httpMethod\":\"$context.httpMethod\",\"routeKey\":\"$context.routeKey\",\"status\":\"$context.status\",\"protocol\":\"$context.protocol\",\"responseLength\":\"$context.responseLength\"}"
    },
    "ApiId": {
     "Ref": "HttpApi"
    },
    "AutoDeploy": true,
    "StageName": "$default"
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/ApiStage"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/+VWS28TMRD+LfiIXFPSAyi3NEKoUoHQVlyiCk3syWLitbf2OFW02v+O7PXmQXkWihAcdnc8nufnmfGOxOjkuTh+BLfhSKrVkdEL0V4SyBWH2/C+1VCL9sIZnLcMQog1qtMNG7es8dpK3YCZSOmiJTZmjxkvMklhIkk7m9kdZzVYqFDNnNFSY2DjeXvA20x8kb3u+J91pdSVmw0ueomkU3aJQH44s0Zb3O6xx+wHNpV6te/1B+L4Vfk9199K6d7Y7mx/bvLhMPxpZ/+QSuUhncg8H8kAyR/pDP77Nu6N1/2q5ppPlzalznt+Bm9QuHJp546du2ylLgkIa7QUDgK+y35o+w/J/l2xZ9B7vBN1ZgOBlTjzbqkNdhzlSLSXKKPXtHnpXWzmLVs3stSrwiC9bralyhkY424nxryJtHDRKjYmH7G4P7OVxxAuYo6rZRJsXwk9J0lyJp21mKs/FJvR6puIZ2qo127bU39JJBnFA5Q6bqBeKBDtOWzQv0MftLPJkVNYjElXN0B6YfAiWtI1hq/k0tvfN9TxcPIeQkAKYpI+PJyI0yhXSKcQkOMqiKmJgdAnnz31GurB9bo3M6y2KK4beRkXFvv6YCHTV5sm6c28XgNhiob5XFlZJeynXXhoVeO0pYmUGHZZLSEamkIDUtOmcFdxgZJMTm7ApQ/33FWVtlUqYIhKUzrSSB/QkpZAzmcELXlnDPr+QvX5LMJNEO3biDH9+tyk717mHilZcHaGXju1h2/W4PldBlDRDgcTak+g47hOvSTaVDXzluXlDIgwzdCWBRe9xG3+BNoUMHd38osDnfl3lLbjF3yFtBsS/53n/raIaUYZVwXRnrtqmE+mkF86djZ+lla1W+8urtRw5N1maLSi3nFodAWEt7BZj0Q7XdpJo3OrE1TYdTy3XlpoW/FpDOTqC+xzGa7+z58+7iLEt8R0aafOKp1CLB7kKhFvIjWROm6dQvExPFmPjsXTZ+L40ceg9ZHvB4coA+QTJAj/7RQMAAA="
   },
   "Metadata": {
    "aws:cdk:path": "NginxApiClusterStack/CDKMetadata/Default"
   }
  }
 },
 "Conditions": {
  "ClusterHasEcrPublic8EE1114E": {
   "Fn::Equals": [
    {
     "Ref": "AWS::Partition"
    },
    "aws"
   ]
  }
 },
 "Outputs": {
  "ClusterNameOutput": {
   "Description": "EKS cluster name",
   "Value": {
    "Ref": "Cluster9EE0221C"
   },
   "Export": {
    "Name": "NginxApiClusterName"
   }
  },
  "ClusterEndpointOutput": {
   "Description": "EKS cluster endpoint",
   "Value": {
    "Fn::GetAtt": [
     "Cluster9EE0221C",
     "Endpoint"
    ]
   },
   "Export": {
    "Name": "NginxApiClusterEndpoint"
   }
  },
  "ClusterArn": {
   "Description": "EKS cluster ARN",
   "Value": {
    "Fn::GetAtt": [
     "Cluster9EE0221C",
     "Arn"
    ]
   }
  },
  "KarpenterNodeRoleArn": {
   "Description": "Karpenter node IAM role ARN",
   "Value": {
    "Fn::GetAtt": [
     "KarpenterNodeRole4664A89A",
     "Arn"
    ]
   }
  },
  "KarpenterControllerRoleArn": {
   "Description": "Karpenter controller IAM role ARN (create via Helm)",
   "Value": "Will be created via Helm with IRSA"
  },
  "KarpenterInstanceProfileName": {
   "Description": "Karpenter instance profile name",
   "Value": {
    "Fn::Join": [
     "",
     [
      "KarpenterNodeInstanceProfile-",
      {
       "Ref": "Cluster9EE0221C"
      }
     ]
    ]
   }
  },
  "KarpenterInterruptionQueueName": {
   "Description": "Karpenter interruption queue name",
   "Value": {
    "Fn::GetAtt": [
     "KarpenterInterruptionQueue89CE5952",
     "QueueName"
    ]
   }
  },
  "ALBControllerRoleArn": {
   "Description": "ALB Controller IAM role ARN (create via Helm)",
   "Value": "Will be created via Helm with IRSA"
  },
  "ALBSecurityGroupId": {
   "Description": "ALB security group ID",
   "Value": {
    "Fn::GetAtt": [
     "ALBSecurityGroup29A3BDEF",
     "GroupId"
    ]
   }
  },
  "ApiGatewayUrl": {
   "Description": "API Gateway public URL",
   "Value": {
    "Fn::Join": [
     "",
     [
      "https://",
      {
       "Ref": "HttpApi"
      },
      ".execute-api.us-west-2.amazonaws.com"
     ]
    ]
   },
   "Export": {
    "Name": "NginxApiGatewayUrl"
   }
  },
  "ApiGatewayId": {
   "Description": "API Gateway ID",
   "Value": {
    "Ref": "HttpApi"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}