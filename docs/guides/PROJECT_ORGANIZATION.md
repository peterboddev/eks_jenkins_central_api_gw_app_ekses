# Project Organization Standards

## Directory Structure Standards

### tmp/ Directories

All `tmp/` directories throughout the project are automatically excluded from git via `.gitignore`.

**Purpose**: Store temporary build artifacts that are:
- Generated during build process
- Not needed in version control
- Specific to local development environment
- Recreatable from source files

**Examples**:
- `nginx-api/tmp/kubectl-layer.zip` - Lambda layer for nginx-api-cluster stack
- Any other temporary build outputs

**Rule**: Keep build artifacts in the subdirectory where they're used, not at project root.

### Why This Approach?

#### ✅ Benefits

1. **Clear Dependencies**: Build artifacts are located near the code that uses them
2. **Modular Organization**: Each component manages its own build artifacts
3. **Easy Cleanup**: `rm -rf */tmp` cleans all temporary files
4. **Standard Pattern**: Developers expect `tmp/` to be temporary
5. **Scalable**: Works for any number of subdirectories

#### ❌ Anti-Patterns to Avoid

1. **Root-level build artifacts**: Don't put `kubectl-layer.zip` at project root
2. **Mixed locations**: Don't scatter build artifacts across random directories
3. **Committed binaries**: Never commit generated files to git
4. **Unclear naming**: Use `tmp/` not `temp/`, `build/`, or custom names

## .gitignore Strategy

### Global Patterns

```gitignore
# Temporary build artifacts
tmp/
```

This single line excludes ALL `tmp/` directories anywhere in the project tree.

### Why Not Specific Paths?

❌ **Don't do this**:
```gitignore
kubectl-layer.zip
nginx-api/kubectl-layer.zip
nginx-api/tmp/kubectl-layer.zip
```

✅ **Do this instead**:
```gitignore
tmp/
```

**Reasons**:
- Scales to any number of components
- No maintenance when adding new components
- Standard convention everyone understands
- Catches all temporary files automatically

## Build Artifact Guidelines

### Where to Put Build Artifacts

1. **Component-specific artifacts**: `{component}/tmp/`
   - Example: `nginx-api/tmp/kubectl-layer.zip`
   - Used by: nginx-api-cluster CDK stack

2. **Project-wide artifacts**: `tmp/` (root level)
   - Example: `tmp/test-results.xml`
   - Used by: Multiple components

3. **CDK outputs**: `cdk.out/` (already in .gitignore)
   - Generated by: CDK synth/deploy
   - Contains: CloudFormation templates

### How to Reference in Code

Use relative paths from project root:

```typescript
// ✅ Good - clear where the file is
lambda.Code.fromAsset('nginx-api/tmp/kubectl-layer.zip')

// ❌ Bad - unclear location
lambda.Code.fromAsset('kubectl-layer.zip')
```

### Automation

Build artifacts should be:
1. **Auto-generated**: Created by build scripts (npm prebuild hooks)
2. **Idempotent**: Running build multiple times produces same result
3. **Fast**: Check if file exists before regenerating
4. **Cross-platform**: Work on Windows, macOS, Linux

Example from `package.json`:
```json
{
  "scripts": {
    "prepare-kubectl-layer": "node scripts/prepare-kubectl-layer.js",
    "prebuild": "npm run prepare-kubectl-layer",
    "build": "tsc"
  }
}
```

## Component Organization

### nginx-api Component

```
nginx-api/
├── tmp/                    # Build artifacts (gitignored)
│   └── kubectl-layer.zip   # Lambda layer (auto-generated)
├── handlers/               # Lambda function handlers
├── app.js                  # Express application
├── openapi.yaml           # API specification
├── package.json           # Dependencies
└── README.md              # Component documentation
```

### lib/ (CDK Stacks)

```
lib/
├── eks_jenkins-stack.ts      # Jenkins infrastructure
└── eks_nginx_api-stack.ts    # nginx-api infrastructure
    └── References: nginx-api/tmp/kubectl-layer.zip
```

## Best Practices Summary

### ✅ Do

- Keep build artifacts in component's `tmp/` directory
- Use `tmp/` as the standard name for temporary files
- Auto-generate artifacts during build
- Reference artifacts with clear relative paths
- Document what goes in `tmp/` and why

### ❌ Don't

- Commit build artifacts to git
- Put artifacts at project root
- Use inconsistent directory names
- Manually create artifacts
- Reference artifacts with unclear paths

## Migration Guide

If you have build artifacts in the wrong location:

1. **Identify the artifact**: What file needs to move?
2. **Find the component**: Which component uses this artifact?
3. **Create tmp/ directory**: `mkdir {component}/tmp`
4. **Update generation script**: Change output path
5. **Update references**: Update code that uses the artifact
6. **Test build**: Ensure `npm run build` works
7. **Clean up**: Delete old artifact location

Example:
```bash
# Before: kubectl-layer.zip at root
# After: nginx-api/tmp/kubectl-layer.zip

# 1. Update script to output to nginx-api/tmp/
# 2. Update CDK stack to reference nginx-api/tmp/kubectl-layer.zip
# 3. Test: npm run build
# 4. Clean: rm kubectl-layer.zip
```

## Related Documentation

- [KUBECTL_LAYER_AUTOMATION.md](KUBECTL_LAYER_AUTOMATION.md) - kubectl-layer.zip specifics
- [BINARY_FILES_CLEANUP.md](BINARY_FILES_CLEANUP.md) - Why binaries don't belong in git
- [SETUP_TOOLS.md](SETUP_TOOLS.md) - Installing development tools
